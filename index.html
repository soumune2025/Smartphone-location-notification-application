<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoNotifier Pro</title>
    <!-- Favicon setting using SVG -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ””</text></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .dot { height: 10px; width: 10px; background-color: #cbd5e1; border-radius: 50%; display: inline-block; }
        .dot-active { background-color: #22c55e; animation: pulse 2s infinite; }
        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        #map { height: 30vh; width: 100%; border-radius: 1.5rem; z-index: 1; }
        .trigger-btn.active { background-color: #2563eb; color: white; border-color: #2563eb; }
        .day-btn.active { background-color: #2563eb; color: white; }
        
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2563eb; }
        input:checked + .slider:before { transform: translateX(20px); }

        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 font-sans pb-36">

    <div class="max-w-md mx-auto p-3">
        <!-- Header -->
        <header class="flex justify-between items-center py-4">
            <div>
                <h1 class="text-xl font-black text-slate-900 tracking-tighter italic">GeoNotifier <span class="text-blue-600">Pro</span></h1>
                <p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest">Smart Location Alert</p>
            </div>
            <div id="status-badge" class="bg-white px-2 py-1 rounded-full shadow-sm border border-slate-100 flex items-center">
                <span id="status-dot" class="dot mr-1.5"></span>
                <span id="status-text" class="text-[9px] font-black text-slate-500 uppercase">Offline</span>
            </div>
        </header>

        <!-- Main Layout Container -->
        <div class="space-y-3">
            <!-- Map Area -->
            <div class="bg-white rounded-[1.8rem] shadow-lg p-1.5 border border-slate-100 overflow-hidden relative">
                <div id="map"></div>
                <!-- Current Location Button -->
                <button onclick="requestAndCenter()" class="absolute bottom-12 right-4 z-[1000] bg-white p-2 rounded-full shadow-md active:bg-slate-100 border border-slate-200" title="ç¾åœ¨åœ°ã«ç§»å‹•">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
                </button>
                <div class="py-2 text-center border-t border-slate-50 flex justify-center items-center gap-2">
                    <span class="text-[9px] font-black text-blue-500 bg-blue-50 px-2 py-0.5 rounded-full uppercase tracking-tighter">Target</span>
                    <p id="curr-coords" class="text-[10px] font-mono font-bold text-slate-400">åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ</p>
                </div>
            </div>

            <!-- Compact Registration Form -->
            <div class="bg-white rounded-[1.8rem] shadow-sm p-4 border border-slate-100">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="col-span-2 sm:col-span-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase mb-1 block tracking-widest">åœ°ç‚¹å</label>
                        <input type="text" id="loc-name" placeholder="ä¾‹: è‡ªå®…" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-500 transition-all font-medium">
                    </div>
                    <div class="col-span-2 sm:col-span-1">
                        <label class="text-[9px] font-black text-slate-400 uppercase mb-1 block tracking-widest">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
                        <input type="text" id="loc-msg" placeholder="ä¾‹: å‚˜æŒã£ãŸï¼Ÿ" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-xs outline-none focus:ring-2 focus:ring-blue-500 transition-all font-medium">
                    </div>
                </div>
                
                <div class="flex gap-2 p-1 bg-slate-100 rounded-xl mb-3">
                    <button onclick="setTrigger('enter')" id="btn-enter" class="trigger-btn active flex-1 py-2 text-[9px] font-black rounded-lg border border-transparent transition-all uppercase">åˆ°ç€</button>
                    <button onclick="setTrigger('exit')" id="btn-exit" class="trigger-btn flex-1 py-2 text-[9px] font-black rounded-lg border border-transparent transition-all uppercase">å‡ºç™º</button>
                </div>

                <!-- Day Selection -->
                <div class="mb-4">
                    <div class="flex justify-between gap-1">
                        <button onclick="toggleDay(1)" class="day-btn active flex-1 py-2 text-[9px] font-bold rounded-lg bg-slate-100 transition-all" data-day="1">æœˆ</button>
                        <button onclick="toggleDay(2)" class="day-btn active flex-1 py-2 text-[9px] font-bold rounded-lg bg-slate-100 transition-all" data-day="2">ç«</button>
                        <button onclick="toggleDay(3)" class="day-btn active flex-1 py-2 text-[9px] font-bold rounded-lg bg-slate-100 transition-all" data-day="3">æ°´</button>
                        <button onclick="toggleDay(4)" class="day-btn active flex-1 py-2 text-[9px] font-bold rounded-lg bg-slate-100 transition-all" data-day="4">æœ¨</button>
                        <button onclick="toggleDay(5)" class="day-btn active flex-1 py-2 text-[9px] font-bold rounded-lg bg-slate-100 transition-all" data-day="5">é‡‘</button>
                        <button onclick="toggleDay(6)" class="day-btn flex-1 py-2 text-[9px] font-bold rounded-lg bg-slate-100 transition-all text-blue-400" data-day="6">åœŸ</button>
                        <button onclick="toggleDay(0)" class="day-btn flex-1 py-2 text-[9px] font-bold rounded-lg bg-slate-100 transition-all text-red-400" data-day="0">æ—¥</button>
                    </div>
                </div>

                <input type="hidden" id="target-lat">
                <input type="hidden" id="target-lon">
                
                <button id="add-btn" class="w-full bg-blue-600 text-white py-3.5 rounded-xl font-black text-xs shadow-lg shadow-blue-100 active:scale-95 transition-all uppercase tracking-widest">åœ°ç‚¹ã‚’ä¿å­˜</button>
            </div>
        </div>

        <!-- List Area -->
        <div class="mt-6 mb-3 flex justify-between items-center px-2">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">ç™»éŒ²ãƒªã‚¹ãƒˆ</h3>
            <button onclick="clearAll()" class="text-[9px] text-red-400 font-bold uppercase tracking-widest">å…¨å‰Šé™¤</button>
        </div>
        <div id="location-list" class="space-y-2 mb-8">
            <!-- Items injected by JS -->
        </div>

        <!-- Collapsible Instruction Manual -->
        <details class="bg-white/50 border border-slate-200 rounded-2xl mb-24 overflow-hidden">
            <summary class="p-4 text-[10px] font-black text-slate-500 flex justify-between items-center cursor-pointer select-none">
                <span><i class="mr-1">â„¹ï¸</i> ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</span>
                <span class="text-slate-300">â–¼</span>
            </summary>
            <div class="p-4 pt-0 text-[11px] space-y-2 text-slate-500 leading-relaxed border-t border-slate-100">
                <p>1. åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ï¼ˆè‡ªå‹•ã§å…¥åŠ›æ¬„ã¸ç§»å‹•ï¼‰</p>
                <p>2. åå‰ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›</p>
                <p>3. æ¡ä»¶ã‚’é¸ã‚“ã§ã€Œåœ°ç‚¹ã‚’ä¿å­˜ã€</p>
                <p>4. ä¸€ç•ªä¸‹ã®ã€Œç›£è¦–é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™</p>
            </div>
        </details>

        <!-- Bottom Controller -->
        <div class="fixed bottom-4 left-1/2 -translate-x-1/2 w-full max-w-md px-4 z-[1000]">
            <div class="bg-white/90 backdrop-blur-xl p-2 rounded-[2rem] shadow-2xl border border-white/20">
                <button id="start-btn" class="w-full py-4 bg-slate-900 text-white font-black rounded-full active:scale-95 transition-all tracking-widest uppercase text-[10px]">GPSç›£è¦–ã‚’é–‹å§‹</button>
                <button id="stop-btn" class="w-full py-4 bg-red-500 text-white font-black rounded-full hidden active:scale-95 transition-all tracking-widest uppercase text-[10px]">ç›£è¦–ã‚’ä¸€æ™‚åœæ­¢</button>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div id="alert-modal" class="fixed inset-0 bg-slate-900/90 hidden flex items-center justify-center p-6 z-[5000] backdrop-blur-sm">
        <div class="bg-white rounded-[2.5rem] p-8 w-full max-w-xs text-center shadow-2xl">
            <div class="w-16 h-16 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl animate-bounce">ğŸ””</div>
            <h3 id="alert-title" class="text-xl font-black mb-1 italic text-slate-900 leading-tight">åœ°ç‚¹å</h3>
            <p id="alert-body" class="text-blue-600 text-base font-bold mb-6 italic underline decoration-blue-100">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</p>
            <button onclick="closeModal()" class="w-full py-3.5 bg-slate-900 text-white font-black rounded-xl text-xs uppercase tracking-widest">OK</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let locations = [];
        let map, userMarker, watchId;
        let markersLayer = L.layerGroup();
        let currentTrigger = 'enter';
        let selectedDays = [1, 2, 3, 4, 5]; // Default: weekdays

        function init() {
            initMap();
            loadFromStorage();
            
            // Initial location request on startup
            requestAndCenter();
        }

        function initMap() {
            // Initial default view
            map = L.map('map', { zoomControl: false }).setView([35.6812, 139.7671], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            markersLayer.addTo(map);

            userMarker = L.circleMarker([35.6812, 139.7671], {
                radius: 6, color: '#fff', weight: 2, fillColor: '#2563eb', fillOpacity: 1
            }).addTo(map);

            map.on('click', (e) => {
                document.getElementById('target-lat').value = e.latlng.lat;
                document.getElementById('target-lon').value = e.latlng.lng;
                document.getElementById('curr-coords').textContent = `${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`;
                document.getElementById('loc-name').focus();
            });
        }

        function requestAndCenter() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    const { latitude, longitude } = pos.coords;
                    userMarker.setLatLng([latitude, longitude]);
                    map.setView([latitude, longitude], 15);
                }, (err) => {
                    console.warn("Failed to get location:", err.message);
                }, { enableHighAccuracy: true });
            } else {
                console.error("Geolocation is not supported by this browser.");
            }
        }

        function setTrigger(type) {
            currentTrigger = type;
            document.getElementById('btn-enter').classList.toggle('active', type === 'enter');
            document.getElementById('btn-exit').classList.toggle('active', type === 'exit');
        }

        function toggleDay(day) {
            const btn = document.querySelector(`.day-btn[data-day="${day}"]`);
            const index = selectedDays.indexOf(day);
            if (index > -1) {
                selectedDays.splice(index, 1);
                btn.classList.remove('active');
            } else {
                selectedDays.push(day);
                btn.classList.add('active');
            }
        }

        document.getElementById('add-btn').onclick = () => {
            const name = document.getElementById('loc-name').value || 'ç™»éŒ²åœ°ç‚¹';
            const msg = document.getElementById('loc-msg').value || 'ç›®çš„åœ°ä»˜è¿‘ã§ã™';
            const lat = parseFloat(document.getElementById('target-lat').value);
            const lon = parseFloat(document.getElementById('target-lon').value);

            if (isNaN(lat)) return alert("åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦åœ°ç‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„");
            if (selectedDays.length === 0) return alert("æœ‰åŠ¹ãªæ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„");

            const newLoc = {
                id: Date.now(),
                name, msg, lat, lon,
                trigger: currentTrigger,
                days: [...selectedDays],
                enabled: true,
                isInside: false
            };

            locations.push(newLoc);
            saveToStorage();
            renderList();
            refreshMapMarkers();
            
            document.getElementById('loc-name').value = "";
            document.getElementById('loc-msg').value = "";
            document.getElementById('target-lat').value = "";
            document.getElementById('target-lon').value = "";
            document.getElementById('curr-coords').textContent = "åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ";
        };

        function refreshMapMarkers() {
            markersLayer.clearLayers();
            locations.forEach(loc => {
                if (!loc.enabled) return;
                const color = loc.trigger === 'enter' ? '#22c55e' : '#f59e0b';
                L.circle([loc.lat, loc.lon], { radius: 150, color: color, weight: 1, fillOpacity: 0.1 }).addTo(markersLayer);
                L.marker([loc.lat, loc.lon]).addTo(markersLayer).bindPopup(`<b>${loc.name}</b>`);
            });
        }

        function renderList() {
            const list = document.getElementById('location-list');
            list.innerHTML = "";
            locations.forEach((loc) => {
                const dayLabels = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
                const dayText = loc.days.length === 7 ? "æ¯æ—¥" : loc.days.sort().map(d => dayLabels[d]).join(",");

                const div = document.createElement('div');
                div.className = `p-4 bg-white rounded-2xl border border-slate-100 shadow-sm flex flex-col gap-1 transition-opacity ${loc.enabled ? '' : 'opacity-60 grayscale'}`;
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-0.5">
                                <span class="text-[6px] font-black px-1.5 py-0.5 rounded bg-slate-50 text-slate-400 uppercase border border-slate-100">${loc.trigger === 'enter' ? 'åˆ°ç€' : 'å‡ºç™º'}</span>
                                <p class="font-bold text-slate-800 text-xs">${loc.name}</p>
                            </div>
                            <p class="text-[10px] text-blue-500 font-semibold mb-0.5">"${loc.msg}"</p>
                            <p class="text-[8px] text-slate-300 font-black uppercase tracking-tight">${dayText}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="deleteLoc(${loc.id})" class="text-slate-200 hover:text-red-400 transition-colors p-1">
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                            </button>
                            <label class="switch">
                                <input type="checkbox" ${loc.enabled ? 'checked' : ''} onchange="toggleLoc(${loc.id})">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function toggleLoc(id) {
            const loc = locations.find(l => l.id === id);
            if (loc) {
                loc.enabled = !loc.enabled;
                saveToStorage();
                renderList();
                refreshMapMarkers();
            }
        }

        function deleteLoc(id) {
            if (confirm("åœ°ç‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                locations = locations.filter(l => l.id !== id);
                saveToStorage();
                renderList();
                refreshMapMarkers();
            }
        }

        document.getElementById('start-btn').onclick = () => {
            document.getElementById('start-btn').classList.add('hidden');
            document.getElementById('stop-btn').classList.remove('hidden');
            document.getElementById('status-dot').classList.add('dot-active');
            document.getElementById('status-text').textContent = "Monitoring";

            watchId = navigator.geolocation.watchPosition(updatePosition, (err) => {
                alert("GPS Error: " + err.message);
                stopMonitoring();
            }, { enableHighAccuracy: true });
        };

        function updatePosition(pos) {
            const { latitude, longitude } = pos.coords;
            userMarker.setLatLng([latitude, longitude]);
            map.panTo([latitude, longitude]);

            const now = new Date();
            const today = now.getDay();

            locations.forEach(loc => {
                if (!loc.enabled || !loc.days.includes(today)) return;

                const distance = map.distance([latitude, longitude], [loc.lat, loc.lon]);
                const currentlyInside = distance <= 150;

                if (loc.trigger === 'enter' && currentlyInside && !loc.isInside) {
                    triggerAlert(loc);
                } else if (loc.trigger === 'exit' && !currentlyInside && loc.isInside) {
                    triggerAlert(loc);
                }
                loc.isInside = currentlyInside;
            });
        }

        function triggerAlert(loc) {
            document.getElementById('alert-title').textContent = loc.name;
            document.getElementById('alert-body').textContent = loc.msg;
            document.getElementById('alert-modal').classList.remove('hidden');
            if ('speechSynthesis' in window) {
                const uttr = new SpeechSynthesisUtterance(`${loc.name}ã€‚${loc.msg}`);
                uttr.lang = 'ja-JP';
                speechSynthesis.speak(uttr);
            }
            if ('vibrate' in navigator) navigator.vibrate([300, 100, 300]);
        }

        function stopMonitoring() {
            if (watchId) navigator.geolocation.clearWatch(watchId);
            document.getElementById('start-btn').classList.remove('hidden');
            document.getElementById('stop-btn').classList.add('hidden');
            document.getElementById('status-dot').classList.remove('dot-active');
            document.getElementById('status-text').textContent = "Offline";
        }
        document.getElementById('stop-btn').onclick = stopMonitoring;

        function closeModal() { document.getElementById('alert-modal').classList.add('hidden'); }
        function saveToStorage() { localStorage.setItem('geo_notifier_v4_locs', JSON.stringify(locations)); }
        function loadFromStorage() {
            const stored = localStorage.getItem('geo_notifier_v4_locs');
            if (stored) {
                locations = JSON.parse(stored);
                renderList();
                refreshMapMarkers();
            }
        }
        function clearAll() {
            if(confirm("ã™ã¹ã¦ã®åœ°ç‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                localStorage.removeItem('geo_notifier_v4_locs');
                location.reload();
            }
        }

        window.onload = init;
    </script>
</body>
</html>
